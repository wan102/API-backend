const fs = require('fs')
const Path = require('path')
const send = require('koa-send')

async function get_Route_FilePath(ctx,data) {
    let dir,router
    if(typeof(data) === 'object')
    {
        if(data instanceof Array)
        {
            for(var item of data){
                if(ctx.request.url&&ctx.request.url.includes(item.router))
                {
                    dir = item.dir
                    router = item.router
                    await toSend(ctx,dir,router)
                }
            }
        }
        else
        {
            dir = data.dir
            router = data.router
        }
        
    } else {
        dir = router = data
    }

    if(!router)
    {
        return
    }

    await toSend(ctx,dir,router)
}

async function toSend(ctx,dir,router) {
    // 文件路径下标
    const index = router === '/' ? 0 : ctx.request.url.lastIndexOf(router)+router.length
    // 链接参数下标
    const paramsStartIndex = ctx.request.url.indexOf('?')
    // 文件路径
    const fileUrl = paramsStartIndex > -1 ? ctx.request.url.substring(index,paramsStartIndex) : ctx.request.url.substring(index)
    // 目录下的文件路径
    const filePath = Path.join( dir,fileUrl)
    
    const isFile = await new Promise((resolve)=>{
        fs.stat(filePath,(err,stats)=>{
            if(err){
                resolve(false)
            }
            else{
                resolve(stats.isFile());
            }
        })
    })
    if(isFile)
    {
        await send(ctx, filePath)
    }
}

function  static(data) {
    return async function static (ctx,next){
        if(ctx.method !== 'HEAD' && ctx.method !== 'GET')
        {
            ctx.body = 'Method Not Allowed'
            await next()
            return;
        }
        if (ctx.body != null || ctx.status !== 404) {
            return;
        }
        await get_Route_FilePath(ctx,data)
        await next()
    }
}

module.exports = static









